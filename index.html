<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Magical AR Love Card</title>
  
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
      "mindar-image-three": "https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"
    }
  }
  </script>
  
  <!-- Mobile Console for Debugging -->
  <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
  <script>eruda.init();</script>
  
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }
    
    #container {
      width: 100vw;
      height: 100vh;
      position: relative;
      overflow: hidden;
    }
    
    #startScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1a0a1f 0%, #2d1b3d 100%);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 100;
      color: white;
      text-align: center;
      padding: 20px;
    }
    
    #startScreen .emoji {
      font-size: 80px;
      margin-bottom: 20px;
      animation: pulse 1.5s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    #startScreen h1 {
      font-size: 32px;
      margin: 20px 0;
      color: #ff5fa2;
    }
    
    #startScreen p {
      font-size: 18px;
      margin: 10px 0;
      opacity: 0.9;
    }
    
    #startButton {
      margin-top: 30px;
      background: linear-gradient(135deg, #ff5fa2, #ff8fc7);
      color: white;
      border: none;
      padding: 20px 50px;
      font-size: 22px;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(255,95,162,0.4);
      font-weight: bold;
    }
    
    #startButton:active {
      transform: scale(0.95);
    }
    
    #instruction {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 15px 30px;
      border-radius: 25px;
      z-index: 5;
      font-size: 16px;
      display: none;
    }
  </style>
</head>

<body>

<div id="startScreen">
  <div class="emoji">üíù</div>
  <h1>Magical AR Love Card</h1>
  <p>Point your camera at any special photo</p>
  <p style="font-size: 16px; opacity: 0.7;">to reveal your magical gifts</p>
  <button id="startButton">‚ú® Start AR Experience ‚ú®</button>
</div>

<div id="instruction">üì∑ Point camera at a photo card</div>

<div id="container"></div>

<audio id="music1" src="./music.mp3" loop></audio>
<audio id="music2" src="./music2.mp3" loop></audio>
<audio id="music3" src="./music3.mp3" loop></audio>

<script type="module">
import * as THREE from 'three';
import { MindARThree } from 'mindar-image-three';

const startScreen = document.getElementById('startScreen');
const startButton = document.getElementById('startButton');
const instruction = document.getElementById('instruction');
const music1 = document.getElementById('music1');
const music2 = document.getElementById('music2');
const music3 = document.getElementById('music3');

let mindarThree, renderer, scene, camera;
let anchors = [];
let currentTrackingIndex = -1;
let audioUnlocked = false;
let audioCtx;
let unlockedMusic = {};

// Initialize MindAR with 3 targets (maxTrack: 1 means only one at a time)
const initAR = async () => {
  mindarThree = new MindARThree({
    container: document.querySelector("#container"),
    imageTargetSrc: "./targets.mind", // Contains all 3 images
    maxTrack: 1 // Only track one photo at a time
  });
  
  ({ renderer, scene, camera } = mindarThree);
  
  // Create 3 anchors (one for each photo)
  for (let i = 0; i < 3; i++) {
    const anchor = mindarThree.addAnchor(i);
    anchors.push(anchor);
    
    // Create effects for each anchor
    createEffects(anchor, i);
  }
  
  // Animation loop
  let time = 0;
  renderer.setAnimationLoop(() => {
    time += 0.016;
    
    // Animate all anchors
    anchors.forEach((anchor, index) => {
      if (!anchor.userData) return;
      
      const { hearts, sparkles, textMesh } = anchor.userData;
      
      // Animate hearts
      hearts.forEach(heart => {
        heart.position.y += heart.userData.velocity.y;
        heart.position.x += heart.userData.velocity.x;
        
        if (heart.position.y > 1.2) {
          heart.position.y = -0.8;
          heart.position.x = (Math.random() - 0.5) * 1.2;
        }
      });
      
      // Animate sparkles
      sparkles.forEach(sparkle => {
        sparkle.userData.angle += sparkle.userData.speed;
        sparkle.position.x = Math.cos(sparkle.userData.angle) * sparkle.userData.radius;
        sparkle.position.z = Math.sin(sparkle.userData.angle) * sparkle.userData.radius;
      });
      
      // Animate text
      if (textMesh) {
        textMesh.scale.setScalar(1 + Math.sin(time * 2.5) * 0.08);
        textMesh.position.y = 0.75 + Math.sin(time * 1.5) * 0.05;
      }
    });
    
    // Beat detection for currently tracked photo
    if (currentTrackingIndex >= 0) {
      const currentMusic = [music1, music2, music3][currentTrackingIndex];
      
      if (currentMusic && !currentMusic.paused && audioCtx) {
        // Create analyser on-demand if needed
        if (!currentMusic.analyser) {
          try {
            const source = audioCtx.createMediaElementSource(currentMusic);
            const analyser = audioCtx.createAnalyser();
            source.connect(analyser);
            analyser.connect(audioCtx.destination);
            analyser.fftSize = 512;
            currentMusic.analyser = analyser;
            currentMusic.dataArray = new Uint8Array(analyser.frequencyBinCount);
          } catch (err) {
            console.log('Analyser setup failed:', err);
          }
        }
        
        if (currentMusic.analyser) {
          currentMusic.analyser.getByteFrequencyData(currentMusic.dataArray);
          
          let lowFreqSum = 0;
          let lowCount = Math.floor(currentMusic.dataArray.length * 0.15);
          for (let i = 0; i < lowCount; i++) {
            lowFreqSum += currentMusic.dataArray[i];
          }
          let avgLow = lowFreqSum / lowCount;
          let beatScale = 1 + (avgLow / 60) * 0.5;
          
          const textMesh = anchors[currentTrackingIndex].userData?.textMesh;
          if (textMesh) {
            textMesh.scale.setScalar(beatScale);
          }
        }
      }
    }
    
    renderer.render(scene, camera);
  });
  
  // Setup target detection for all 3 photos
  anchors.forEach((anchor, index) => {
    anchor.onTargetFound = () => {
      console.log(`Target ${index + 1} found!`);
      currentTrackingIndex = index;
      instruction.style.display = 'none';
      
      // Stop all music first
      [music1, music2, music3].forEach(m => {
        m.pause();
        m.currentTime = 0;
      });
      
      // Play the corresponding music
      const musicToPlay = [music1, music2, music3][index];
      console.log(`Playing music ${index + 1}`);
      
      musicToPlay.play()
        .then(() => {
          console.log(`Music ${index + 1} playing successfully!`);
        })
        .catch(err => {
          console.error(`Music ${index + 1} play failed:`, err.name, err.message);
        });
    };
    
    anchor.onTargetLost = () => {
      console.log(`Target ${index + 1} lost`);
      
      if (currentTrackingIndex === index) {
        currentTrackingIndex = -1;
        instruction.style.display = 'block';
        instruction.textContent = 'üì∑ Point camera at a photo card';
        instruction.style.background = 'rgba(0,0,0,0.7)';
        
        // Stop music
        const musicToStop = [music1, music2, music3][index];
        musicToStop.pause();
        musicToStop.currentTime = 0;
        console.log(`Music ${index + 1} stopped`);
      }
    };
  });
};

// Play music directly (already unlocked)
function playMusicDirectly(musicElement, index) {
  musicElement.play()
    .then(() => {
      console.log(`Music ${index + 1} playing!`);
    })
    .catch(err => {
      console.error(`Music ${index + 1} play failed:`, err.name);
      // If it fails, show button
      pendingMusicIndex = index;
      playButton.style.display = 'block';
    });
}

// Helper function to play music (unlock on first play if needed)
async function playMusic(musicElement, index) {
  // If this music hasn't been unlocked yet, unlock it now
  if (!unlockedMusic[index]) {
    console.log(`Unlocking music ${index + 1}...`);
    try {
      musicElement.volume = 0;
      await musicElement.play();
      musicElement.pause();
      musicElement.currentTime = 0;
      musicElement.volume = 1;
      unlockedMusic[index] = true;
      console.log(`Music ${index + 1} unlocked`);
    } catch (err) {
      console.log(`Failed to unlock music ${index + 1}:`, err);
    }
  }
  
  // Now play it
  musicElement.play()
    .then(() => {
      console.log(`Music ${index + 1} playing successfully!`);
      playButton.style.display = 'none';
    })
    .catch(err => {
      console.error(`Music ${index + 1} play failed:`, err.name, err.message);
    });
}

// Play button handler
playButton.addEventListener('click', async () => {
  if (pendingMusicIndex >= 0) {
    const musicToPlay = [music1, music2, music3][pendingMusicIndex];
    await playMusic(musicToPlay, pendingMusicIndex);
  }
});

// Create effects for each anchor
function createEffects(anchor, index) {
  const hearts = [];
  const sparkles = [];
  
  // Create hearts particles
  const heartCanvas = document.createElement('canvas');
  heartCanvas.width = 64;
  heartCanvas.height = 64;
  const heartCtx = heartCanvas.getContext('2d');
  heartCtx.font = '50px Arial';
  heartCtx.textAlign = 'center';
  heartCtx.textBaseline = 'middle';
  heartCtx.fillText('‚ù§Ô∏è', 32, 32);
  
  const heartTexture = new THREE.CanvasTexture(heartCanvas);
  const heartSpriteMaterial = new THREE.SpriteMaterial({ 
    map: heartTexture,
    transparent: true,
    opacity: 0.9
  });
  
  for (let i = 0; i < 30; i++) {
    const heart = new THREE.Sprite(heartSpriteMaterial.clone());
    heart.scale.set(0.08, 0.08, 1);
    heart.position.set(
      (Math.random() - 0.5) * 1.2,
      -0.8 + Math.random() * 0.2,
      0.05
    );
    heart.userData.velocity = {
      y: 0.003 + Math.random() * 0.004,
      x: (Math.random() - 0.5) * 0.002
    };
    hearts.push(heart);
    anchor.group.add(heart);
  }
  
  // Create sparkles
  const sparkleGeometry = new THREE.SphereGeometry(0.008, 8, 8);
  const sparkleMaterial = new THREE.MeshBasicMaterial({ 
    color: 0xffffff,
    transparent: true,
    opacity: 0.8
  });
  
  for (let i = 0; i < 80; i++) {
    const sparkle = new THREE.Mesh(sparkleGeometry, sparkleMaterial.clone());
    const angle = (i / 80) * Math.PI * 2;
    const radius = 0.4 + Math.random() * 0.3;
    sparkle.position.set(
      Math.cos(angle) * radius,
      0.6 + Math.random() * 0.3,
      0.02
    );
    sparkle.userData.angle = angle;
    sparkle.userData.radius = radius;
    sparkle.userData.speed = 0.015 + Math.random() * 0.015;
    sparkles.push(sparkle);
    anchor.group.add(sparkle);
  }
  
  // Create "I ‚ù§Ô∏è You" text
  const canvas = document.createElement('canvas');
  canvas.width = 1024;
  canvas.height = 256;
  const ctx = canvas.getContext('2d');
  
  ctx.shadowBlur = 30;
  ctx.shadowColor = '#ff5fa2';
  ctx.fillStyle = '#ffcee8';
  ctx.font = 'bold 120px Arial';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText('I ‚ù§Ô∏è You', 512, 128);
  
  const texture = new THREE.CanvasTexture(canvas);
  const material = new THREE.MeshBasicMaterial({ 
    map: texture,
    transparent: true,
    side: THREE.DoubleSide,
    depthTest: false
  });
  const geometry = new THREE.PlaneGeometry(1.2, 0.3);
  const textMesh = new THREE.Mesh(geometry, material);
  textMesh.position.set(0, 0.75, 0.04);
  textMesh.renderOrder = 999;
  
  anchor.group.add(textMesh);
  
  // Store references
  anchor.userData = { hearts, sparkles, textMesh };
}

// Start button handler
startButton.addEventListener('click', async () => {
  console.log('Start button clicked');
  
  startScreen.style.display = 'none';
  instruction.style.display = 'block';
  instruction.textContent = 'Loading...';
  
  try {
    // Create AudioContext
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    // Unlock ALL 3 music files during this user interaction
    console.log('Unlocking all 3 music files...');
    
    // Music 1
    music1.volume = 0;
    music1.muted = true;
    await music1.play();
    await music1.pause();
    music1.currentTime = 0;
    music1.muted = false;
    music1.volume = 1;
    unlockedMusic[0] = true;
    console.log('Music 1 unlocked');
    
    // Small delay between unlocks
    await new Promise(resolve => setTimeout(resolve, 50));
    
    // Music 2
    music2.volume = 0;
    music2.muted = true;
    await music2.play();
    await music2.pause();
    music2.currentTime = 0;
    music2.muted = false;
    music2.volume = 1;
    unlockedMusic[1] = true;
    console.log('Music 2 unlocked');
    
    await new Promise(resolve => setTimeout(resolve, 50));
    
    // Music 3
    music3.volume = 0;
    music3.muted = true;
    await music3.play();
    await music3.pause();
    music3.currentTime = 0;
    music3.muted = false;
    music3.volume = 1;
    unlockedMusic[2] = true;
    console.log('Music 3 unlocked');
    
    if (audioCtx.state === 'suspended') {
      await audioCtx.resume();
    }
    
    audioUnlocked = true;
    console.log('All 3 music files unlocked successfully!');
  } catch (err) {
    console.log('Audio setup failed:', err);
  }
  
  // Initialize AR
  console.log('Initializing AR...');
  await initAR();
  console.log('AR initialized');
  
  instruction.textContent = 'üì∑ Point camera at a photo card';
  instruction.style.background = 'rgba(0,0,0,0.7)';
  
  // Start AR tracking
  console.log('Starting AR tracking...');
  await mindarThree.start();
  console.log('AR tracking started - point at any photo!');
});

console.log('Magical AR Love Card loaded');
</script>

</body>
</html>
