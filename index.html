<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Magical AR Love Card</title>
  
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
      "mindar-image-three": "https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"
    }
  }
  </script>
  
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }
    
    #container {
      width: 100vw;
      height: 100vh;
      position: relative;
      overflow: hidden;
    }
    
    #startScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1a0a1f 0%, #2d1b3d 100%);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 100;
      color: white;
      text-align: center;
      padding: 20px;
    }
    
    #startScreen .emoji {
      font-size: 80px;
      margin-bottom: 20px;
      animation: pulse 1.5s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    #startScreen h1 {
      font-size: 32px;
      margin: 20px 0;
      color: #ff5fa2;
    }
    
    #startScreen p {
      font-size: 18px;
      margin: 10px 0;
      opacity: 0.9;
    }
    
    #startButton {
      margin-top: 30px;
      background: linear-gradient(135deg, #ff5fa2, #ff8fc7);
      color: white;
      border: none;
      padding: 20px 50px;
      font-size: 22px;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(255,95,162,0.4);
      font-weight: bold;
    }
    
    #startButton:active {
      transform: scale(0.95);
    }
    
    #instruction {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 15px 30px;
      border-radius: 25px;
      z-index: 5;
      font-size: 16px;
      display: none;
    }
  </style>
</head>

<body>

<div id="startScreen">
  <div class="emoji">üíù</div>
  <h1>Magical AR Love Card</h1>
  <p>Point your camera at the special photo</p>
  <p style="font-size: 16px; opacity: 0.7;">to reveal your magical gift</p>
  <button id="startButton">‚ú® Start AR Experience ‚ú®</button>
</div>

<div id="instruction">üì∑ Point camera at the photo card</div>

<div id="container"></div>

<audio id="music" src="./music.mp3" loop></audio>

<script type="module">
import * as THREE from 'three';
import { MindARThree } from 'mindar-image-three';

const startScreen = document.getElementById('startScreen');
const startButton = document.getElementById('startButton');
const instruction = document.getElementById('instruction');
const music = document.getElementById('music');

let mindarThree, renderer, scene, camera, anchor;
let hearts = [];
let sparkles = [];
let textMeshes = [];
let heart3D;
let audioUnlocked = false;
let audioCtx, analyser, source, dataArray;
let isTracking = false;

// Initialize MindAR
const initAR = async () => {
  mindarThree = new MindARThree({
    container: document.querySelector("#container"),
    imageTargetSrc: "./targets.mind"
  });
  
  ({ renderer, scene, camera } = mindarThree);
  anchor = mindarThree.addAnchor(0);
  
  // Create hearts particles (using heart shape sprites)
  const heartCanvas = document.createElement('canvas');
  heartCanvas.width = 64;
  heartCanvas.height = 64;
  const heartCtx = heartCanvas.getContext('2d');
  heartCtx.font = '50px Arial';
  heartCtx.textAlign = 'center';
  heartCtx.textBaseline = 'middle';
  heartCtx.fillText('‚ù§Ô∏è', 32, 32);
  
  const heartTexture = new THREE.CanvasTexture(heartCanvas);
  const heartSpriteMaterial = new THREE.SpriteMaterial({ 
    map: heartTexture,
    transparent: true,
    opacity: 0.9
  });
  
  for (let i = 0; i < 30; i++) {
    const heart = new THREE.Sprite(heartSpriteMaterial.clone());
    heart.scale.set(0.08, 0.08, 1);
    heart.position.set(
      (Math.random() - 0.5) * 1.2,
      -0.8 + Math.random() * 0.2,
      0.05
    );
    heart.userData.velocity = {
      y: 0.003 + Math.random() * 0.004,
      x: (Math.random() - 0.5) * 0.002
    };
    hearts.push(heart);
    anchor.group.add(heart);
  }
  
  // Create sparkles (smaller and more subtle)
  const sparkleGeometry = new THREE.SphereGeometry(0.008, 8, 8);
  const sparkleMaterial = new THREE.MeshBasicMaterial({ 
    color: 0xffffff,
    transparent: true,
    opacity: 0.8
  });
  
  for (let i = 0; i < 80; i++) {
    const sparkle = new THREE.Mesh(sparkleGeometry, sparkleMaterial.clone());
    const angle = (i / 80) * Math.PI * 2;
    const radius = 0.4 + Math.random() * 0.3;
    sparkle.position.set(
      Math.cos(angle) * radius,
      0.6 + Math.random() * 0.3,
      0.02
    );
    sparkle.userData.angle = angle;
    sparkle.userData.radius = radius;
    sparkle.userData.speed = 0.015 + Math.random() * 0.015;
    sparkles.push(sparkle);
    anchor.group.add(sparkle);
  }
  
  // Create 3D heart (smaller and positioned above photo)
  const heartGroup = new THREE.Group();
  
  // Two spheres for top of heart
  const sphere1 = new THREE.Mesh(
    new THREE.SphereGeometry(0.06, 16, 16),
    new THREE.MeshBasicMaterial({ color: 0xff5fa2 })
  );
  sphere1.position.set(-0.04, 0, 0);
  heartGroup.add(sphere1);
  
  const sphere2 = new THREE.Mesh(
    new THREE.SphereGeometry(0.06, 16, 16),
    new THREE.MeshBasicMaterial({ color: 0xff5fa2 })
  );
  sphere2.position.set(0.04, 0, 0);
  heartGroup.add(sphere2);
  
  // Bottom part of heart
  const coneGeometry = new THREE.ConeGeometry(0.09, 0.14, 16);
  const cone = new THREE.Mesh(
    coneGeometry,
    new THREE.MeshBasicMaterial({ color: 0xff5fa2 })
  );
  cone.position.set(0, -0.08, 0);
  cone.rotation.z = Math.PI;
  heartGroup.add(cone);
  
  heartGroup.position.set(0, 0.65, 0.03);
  
  heart3D = heartGroup;
  anchor.group.add(heart3D);
  
  // Create text using canvas texture - positioned above photo
  const createText = (text, x) => {
    const canvas = document.createElement('canvas');
    canvas.width = 512;
    canvas.height = 256;
    const ctx = canvas.getContext('2d');
    
    // Add glow effect
    ctx.shadowBlur = 20;
    ctx.shadowColor = '#ff5fa2';
    
    ctx.fillStyle = '#ffcee8';
    ctx.font = 'bold 120px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(text, 256, 128);
    
    const texture = new THREE.CanvasTexture(canvas);
    const material = new THREE.MeshBasicMaterial({ 
      map: texture,
      transparent: true,
      side: THREE.DoubleSide,
      depthTest: false
    });
    const geometry = new THREE.PlaneGeometry(0.35, 0.175);
    const mesh = new THREE.Mesh(geometry, material);
    mesh.position.set(x, 0.85, 0.04);
    mesh.renderOrder = 999;
    
    anchor.group.add(mesh);
    textMeshes.push(mesh);
    return mesh;
  };
  
  const textI = createText('I', -0.35);
  const textYou = createText('You', 0.35);
  
  // Animation loop
  let time = 0;
  renderer.setAnimationLoop(() => {
    time += 0.016;
    
    // Animate hearts
    hearts.forEach(heart => {
      heart.position.y += heart.userData.velocity.y;
      heart.position.x += heart.userData.velocity.x;
      
      // Reset when goes too high
      if (heart.position.y > 1.2) {
        heart.position.y = -0.8;
        heart.position.x = (Math.random() - 0.5) * 1.2;
      }
    });
    
    // Animate sparkles
    sparkles.forEach(sparkle => {
      sparkle.userData.angle += sparkle.userData.speed;
      sparkle.position.x = Math.cos(sparkle.userData.angle) * sparkle.userData.radius;
      sparkle.position.z = Math.sin(sparkle.userData.angle) * sparkle.userData.radius;
    });
    
    // Animate 3D heart
    if (heart3D) {
      heart3D.rotation.y = time * 0.5;
      heart3D.scale.setScalar(1 + Math.sin(time * 3) * 0.1);
    }
    
    // Animate text
    textMeshes.forEach(mesh => {
      mesh.scale.setScalar(1 + Math.sin(time * 2) * 0.1);
    });
    
    // Beat detection pulse
    if (isTracking && audioCtx && analyser) {
      analyser.getByteFrequencyData(dataArray);
      
      let lowFreqSum = 0;
      let lowCount = Math.floor(dataArray.length * 0.15);
      for (let i = 0; i < lowCount; i++) {
        lowFreqSum += dataArray[i];
      }
      let avgLow = lowFreqSum / lowCount;
      let beatScale = 1 + (avgLow / 150) * 0.3;
      
      if (heart3D) {
        heart3D.scale.setScalar(beatScale);
      }
    }
    
    renderer.render(scene, camera);
  });
};

// Start button handler
startButton.addEventListener('click', async () => {
  try {
    // Setup audio
    await music.play();
    music.pause();
    music.currentTime = 0;
    
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    source = audioCtx.createMediaElementSource(music);
    analyser = audioCtx.createAnalyser();
    source.connect(analyser);
    analyser.connect(audioCtx.destination);
    analyser.fftSize = 512;
    dataArray = new Uint8Array(analyser.frequencyBinCount);
    
    audioUnlocked = true;
    console.log('Audio unlocked');
  } catch (err) {
    console.log('Audio setup failed:', err);
  }
  
  // Initialize AR
  await initAR();
  
  // Hide start screen
  startScreen.style.display = 'none';
  instruction.style.display = 'block';
  
  // Start AR tracking
  await mindarThree.start();
  console.log('AR Started');
  
  // Listen for anchor events
  anchor.onTargetFound = () => {
    console.log('Target found!');
    isTracking = true;
    instruction.textContent = 'üíñ Magic activated!';
    instruction.style.background = 'rgba(255,95,162,0.8)';
    
    if (audioUnlocked) {
      music.play().catch(err => console.log('Music play failed:', err));
    }
  };
  
  anchor.onTargetLost = () => {
    console.log('Target lost');
    isTracking = false;
    instruction.textContent = 'üì∑ Point camera at the photo card';
    instruction.style.background = 'rgba(0,0,0,0.7)';
    
    if (audioUnlocked) {
      music.pause();
      music.currentTime = 0;
    }
  };
});

console.log('Magical AR Love Card loaded');
</script>

</body>
</html>
